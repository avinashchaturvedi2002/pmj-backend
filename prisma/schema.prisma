// Prisma Schema for Plan My Journey
// Database: MySQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  role      Role     @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  trips             Trip[]
  poolGroups        PoolGroup[]
  groupMembers      GroupMember[]
  bookings          Booking[]
  payments          Payment[]
  seatReservations  BusSeatReservation[]
  roomAllocations   HotelRoomAllocation[]

  @@map("users")
}

enum Role {
  USER
  ADMIN
}

// ============================================
// TRIP MANAGEMENT
// ============================================

model Trip {
  id          String   @id @default(cuid())
  source                String
  destination           String
  startDate             DateTime
  endDate               DateTime
  budget                Int      // Total budget in INR
  activityBudgetPercent Int      @default(30) // Percentage for activities/food/misc (0-75)
  travelers             Int      @default(1) // Number of travelers
  status                TripStatus @default(PLANNED)
  createdById           String
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  createdBy        User                 @relation(fields: [createdById], references: [id], onDelete: Cascade)
  poolGroups       PoolGroup[]
  bookings         Booking[]
  packages         Package[]
  payments         Payment[]
  seatReservations BusSeatReservation[]
  roomAllocations  HotelRoomAllocation[]

  @@index([createdById])
  @@index([destination])
  @@index([startDate])
  @@map("trips")
}

enum TripStatus {
  PLANNED
  BOOKED
  COMPLETED
  CANCELLED
}

// ============================================
// TRAVEL POOLING / GROUP MANAGEMENT
// ============================================

model PoolGroup {
  id                String      @id @default(cuid())
  tripId            String
  groupSize         Int         // Maximum group size
  currentSize       Int         @default(1) // Current number of members
  status            GroupStatus @default(OPEN)
  description       String?     @db.Text
  createdById       String
  perPersonCost     Int?        // Fixed cost per member in INR
  selectedPackageId String?     // Package selected by admin
  packageApprovedBy String?     @db.Text // JSON array of user IDs who approved
  paymentDeadline   DateTime?   // Deadline for payment
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  trip            Trip          @relation(fields: [tripId], references: [id], onDelete: Cascade)
  createdBy       User          @relation(fields: [createdById], references: [id], onDelete: Cascade)
  selectedPackage Package?      @relation("SelectedPackage", fields: [selectedPackageId], references: [id], onDelete: SetNull)
  members         GroupMember[]
  packages        Package[]     @relation("GroupPackages")
  payments        Payment[]

  @@index([tripId])
  @@index([createdById])
  @@index([status])
  @@index([selectedPackageId])
  @@map("pool_groups")
}

enum GroupStatus {
  OPEN
  CLOSED
  LOCKED
  COMPLETED
}

model GroupMember {
  id            String        @id @default(cuid())
  poolGroupId   String
  userId        String
  status        MemberStatus  @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  amountPaid    Int?          // Amount paid by this member in INR
  paidAt        DateTime?     // When payment was completed
  joinedAt      DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  poolGroup PoolGroup @relation(fields: [poolGroupId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments  Payment[]

  @@unique([poolGroupId, userId])
  @@index([poolGroupId])
  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
  @@map("group_members")
}

enum MemberStatus {
  PENDING         // Join request pending
  APPROVED        // Approved by admin, awaiting payment
  PAYMENT_PENDING // Payment initiated
  PAID            // Payment successful
  PAYMENT_FAILED  // Payment failed
  REJECTED        // Join request rejected
  CANCELLED       // Member left or cancelled
}

// ============================================
// BUS MANAGEMENT
// ============================================

model Bus {
  id           String   @id @default(cuid())
  busNumber    String   @unique
  busName      String
  capacity     Int
  pricePerSeat Int      // Price in INR
  amenities    String?  @db.Text // JSON string: AC, WiFi, etc.
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  seats            BusSeat[]
  packages         Package[]
  busBookings      BusBooking[]
  payments         Payment[]
  seatReservations BusSeatReservation[]

  @@map("buses")
}

model BusSeat {
  id          String   @id @default(cuid())
  busId       String
  seatNumber  String
  isBooked    Boolean  @default(false)
  deck        String?  // upper, lower, single, etc.
  rowIndex    Int?
  columnIndex Int?
  seatType    SeatType @default(STANDARD)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  bus          Bus                  @relation(fields: [busId], references: [id], onDelete: Cascade)
  reservations BusSeatReservation[] @relation("BusSeatReservations")

  @@unique([busId, seatNumber])
  @@index([busId])
  @@index([isBooked])
  @@map("bus_seats")
}

// ============================================
// HOTEL MANAGEMENT
// ============================================

model Hotel {
  id           String   @id @default(cuid())
  name         String
  location     String
  address      String?  @db.Text
  totalRooms   Int
  pricePerRoom Int      // Price in INR
  rating       Float?   @default(0)
  amenities    String?  @db.Text // JSON string: Pool, Gym, etc.
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  rooms           HotelRoom[]
  packages        Package[]
  hotelBookings   HotelBooking[]
  payments        Payment[]
  roomAllocations HotelRoomAllocation[]

  @@index([location])
  @@map("hotels")
}

model HotelRoom {
  id         String   @id @default(cuid())
  hotelId    String
  roomNumber String
  roomType   String   @default("Standard") // Standard, Deluxe, Suite
  isBooked   Boolean  @default(false)
  floor      Int?
  capacity   Int?     @default(2)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  hotel       Hotel                 @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  allocations HotelRoomAllocation[] @relation("HotelRoomAllocations")

  @@unique([hotelId, roomNumber])
  @@index([hotelId])
  @@index([isBooked])
  @@map("hotel_rooms")
}

model BusSeatReservation {
  id            String                 @id @default(cuid())
  busId         String
  busSeatId     String?
  tripId        String
  journeyDate   DateTime               @db.Date
  seatNumber    String
  status        SeatReservationStatus  @default(HELD)
  holdToken     String?
  holdExpiresAt DateTime?
  bookingId     String?
  paymentId     String?
  userId        String
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt

  bus       Bus        @relation(fields: [busId], references: [id], onDelete: Cascade)
  busSeat   BusSeat?   @relation("BusSeatReservations", fields: [busSeatId], references: [id], onDelete: SetNull)
  trip      Trip       @relation(fields: [tripId], references: [id], onDelete: Cascade)
  booking   Booking?   @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  payment   Payment?   @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([busId, journeyDate, seatNumber], map: "ux_bus_seat_journey")
  @@index([busId, journeyDate])
  @@index([tripId])
  @@index([bookingId])
  @@index([paymentId])
  @@index([holdExpiresAt])
  @@map("bus_seat_reservations")
}

model HotelRoomAllocation {
  id            String                @id @default(cuid())
  hotelId       String
  hotelRoomId   String?
  tripId        String
  roomNumber    String
  checkIn       DateTime              @db.Date
  checkOut      DateTime              @db.Date
  status        RoomAllocationStatus  @default(HELD)
  holdToken     String?
  holdExpiresAt DateTime?
  bookingId     String?
  paymentId     String?
  userId        String
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  hotel     Hotel       @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  hotelRoom HotelRoom?  @relation("HotelRoomAllocations", fields: [hotelRoomId], references: [id], onDelete: SetNull)
  trip      Trip        @relation(fields: [tripId], references: [id], onDelete: Cascade)
  booking   Booking?    @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  payment   Payment?    @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([hotelId, roomNumber, checkIn], map: "ux_hotel_room_checkin")
  @@index([hotelId, checkIn, checkOut])
  @@index([tripId])
  @@index([bookingId])
  @@index([paymentId])
  @@index([holdExpiresAt])
  @@map("hotel_room_allocations")
}

// ============================================
// BOOKING MANAGEMENT
// ============================================

model Booking {
  id          String        @id @default(cuid())
  userId      String
  tripId      String
  packageId   String?       // Optional package reference
  totalPrice  Int           // Total price in INR
  status      BookingStatus @default(INITIATED)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  trip          Trip           @relation(fields: [tripId], references: [id], onDelete: Cascade)
  package       Package?       @relation(fields: [packageId], references: [id], onDelete: SetNull)
  payments      Payment[]
  busBookings   BusBooking[]   // Multiple bus bookings (outbound + return)
  hotelBookings HotelBooking[] // Hotel bookings
  seatReservations BusSeatReservation[]
  roomAllocations  HotelRoomAllocation[]

  @@index([userId])
  @@index([tripId])
  @@index([packageId])
  @@index([status])
  @@map("bookings")
}

enum BookingStatus {
  INITIATED       // Booking initiated
  PENDING_PAYMENT // Awaiting payment
  PAYMENT_FAILED  // Payment failed
  CONFIRMED       // Payment successful, booking confirmed
  CANCELLED       // Booking cancelled
  COMPLETED       // Trip completed
  REFUNDED        // Refund processed
}

// ============================================
// PACKAGE MANAGEMENT (Admin Creates)
// ============================================

model Package {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  tripId      String?
  poolGroupId String?
  busId       String
  hotelId     String
  price       Int      // Package price in INR
  discount    Int?     @default(0) // Discount percentage
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  trip                 Trip?       @relation(fields: [tripId], references: [id], onDelete: SetNull)
  poolGroup            PoolGroup?  @relation("GroupPackages", fields: [poolGroupId], references: [id], onDelete: SetNull)
  bus                  Bus         @relation(fields: [busId], references: [id], onDelete: Cascade)
  hotel                Hotel       @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  selectedByPoolGroups PoolGroup[] @relation("SelectedPackage")
  payments             Payment[]
  bookings             Booking[]

  @@index([tripId])
  @@index([poolGroupId])
  @@index([busId])
  @@index([hotelId])
  @@index([isActive])
  @@map("packages")
}

// ============================================
// PAYMENT MANAGEMENT
// ============================================

model Payment {
  id                  String        @id @default(cuid())
  userId              String
  bookingId           String?
  poolGroupId         String?
  groupMemberId       String?
  tripId              String?       // Store trip for direct package purchases
  packageId           String?       // Store package for direct purchases
  busId               String?       // Store bus for booking creation
  hotelId             String?       // Store hotel for booking creation
  amount              Int           // Amount in paise (INR * 100)
  currency            String        @default("INR")
  razorpayOrderId     String?       @unique
  razorpayPaymentId   String?       @unique
  razorpaySignature   String?       @db.Text
  status              PaymentStatus @default(PENDING)
  paymentMethod       String?       // card, upi, netbanking, etc.
  failureReason       String?       @db.Text
  itinerary           String?       @db.Text
  itineraryGeneratedAt DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // Relations
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  booking          Booking?            @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  poolGroup        PoolGroup?          @relation(fields: [poolGroupId], references: [id], onDelete: SetNull)
  groupMember      GroupMember?        @relation(fields: [groupMemberId], references: [id], onDelete: SetNull)
  trip             Trip?               @relation(fields: [tripId], references: [id], onDelete: SetNull)
  package          Package?            @relation(fields: [packageId], references: [id], onDelete: SetNull)
  bus              Bus?                @relation(fields: [busId], references: [id], onDelete: SetNull)
  hotel            Hotel?              @relation(fields: [hotelId], references: [id], onDelete: SetNull)
  seatReservations BusSeatReservation[]
  roomAllocations  HotelRoomAllocation[]

  @@index([userId])
  @@index([bookingId])
  @@index([poolGroupId])
  @@index([groupMemberId])
  @@index([tripId])
  @@index([packageId])
  @@index([status])
  @@index([razorpayOrderId])
  @@index([razorpayPaymentId])
  @@map("payments")
}

enum PaymentStatus {
  PENDING
  INITIATED
  PROCESSING
  SUCCESS
  FAILED
  REFUNDED
  CANCELLED
}

enum SeatType {
  STANDARD
  WINDOW
  AISLE
  SLEEPER
  SEMI_SLEEPER
}

enum SeatReservationStatus {
  HELD
  BOOKED
  RELEASED
  EXPIRED
}

enum RoomAllocationStatus {
  HELD
  BOOKED
  RELEASED
  EXPIRED
}

// ============================================
// DATE-BASED AVAILABILITY TRACKING
// ============================================

model BusBooking {
  id           String   @id @default(cuid())
  bookingId    String   // Link to main booking
  busId        String
  bookingDate  DateTime @db.Date // Date of journey
  seatsBooked  Int      // Number of seats booked for this date
  seatNumbers  String?  @db.Text // JSON array of seat numbers booked
  pricePerSeat Int      // Price per seat at time of booking
  totalPrice   Int      // seatsBooked * pricePerSeat
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  bus     Bus     @relation(fields: [busId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([busId])
  @@index([bookingDate])
  @@map("bus_bookings")
}

model HotelBooking {
  id           String   @id @default(cuid())
  bookingId    String   // Link to main booking
  hotelId      String
  checkIn      DateTime @db.Date
  checkOut     DateTime @db.Date
  roomsBooked  Int      // Number of rooms booked for this date range
  roomNumbers  String?  @db.Text // JSON array of room numbers booked
  pricePerRoom Int      // Price per room per night at time of booking
  totalPrice   Int      // roomsBooked * nights * pricePerRoom
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  hotel   Hotel   @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([hotelId])
  @@index([checkIn])
  @@index([checkOut])
  @@index([hotelId, checkIn, checkOut])
  @@map("hotel_bookings")
}
